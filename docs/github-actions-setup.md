# GitHub Actions è‡ªåŠ¨éƒ¨ç½²é…ç½®æŒ‡å—

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•é…ç½® GitHub Actions å®ç°ä»£ç æäº¤åè‡ªåŠ¨æ„å»º Docker é•œåƒå¹¶éƒ¨ç½²åˆ°æœåŠ¡å™¨ã€‚

## ğŸ“‹ å‰ç½®æ¡ä»¶

1. **GitHub ä»“åº“**: ç¡®ä¿ä»£ç å·²æ¨é€åˆ° GitHub
2. **Harbor ç§æœ‰ä»“åº“**: ä½¿ç”¨ [Harbor](http://harbor.5845.cn/) ä½œä¸ºç§æœ‰é•œåƒä»“åº“
3. **æœåŠ¡å™¨**: éœ€è¦ä¸€å°è¿è¡Œ Docker çš„æœåŠ¡å™¨
4. **GitHub Secrets**: éœ€è¦åœ¨ä»“åº“ä¸­é…ç½®æœåŠ¡å™¨è¿æ¥ä¿¡æ¯å’ŒHarborè®¤è¯ä¿¡æ¯

## ğŸ”§ é…ç½®æ­¥éª¤

### 1. é…ç½® GitHub Secrets

åœ¨ GitHub ä»“åº“ä¸­ï¼Œè¿›å…¥ `Settings` â†’ `Secrets and variables` â†’ `Actions`ï¼Œæ·»åŠ ä»¥ä¸‹ secretsï¼š

| Secret åç§° | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|------------|------|--------|
| `HARBOR_USERNAME` | Harborç”¨æˆ·å | `admin` |
| `HARBOR_PASSWORD` | Harborå¯†ç  | `your-password` |
| `SERVER_HOST` | æœåŠ¡å™¨IPåœ°å€ | `192.168.1.100` |
| `SERVER_USERNAME` | SSHç”¨æˆ·å | `root` |
| `SERVER_SSH_KEY` | SSHç§é’¥å†…å®¹ | `-----BEGIN OPENSSH PRIVATE KEY-----...` |
| `SERVER_PORT` | SSHç«¯å£ | `22` |

### 2. Harbor ä»“åº“é…ç½®

ç¡®ä¿åœ¨ Harbor ä¸­å·²åˆ›å»ºé¡¹ç›®ï¼š
- **é¡¹ç›®åç§°**: `myapi`
- **è®¿é—®çº§åˆ«**: ç§æœ‰
- **é•œåƒåç§°**: `myapi`
- **å®Œæ•´é•œåƒè·¯å¾„**: `harbor.5845.cn/myapi/myapi`

### 3. ç”Ÿæˆ SSH å¯†é’¥å¯¹

å¦‚æœè¿˜æ²¡æœ‰ SSH å¯†é’¥ï¼Œè¯·ç”Ÿæˆä¸€å¯¹ï¼š

```bash
# ç”Ÿæˆ SSH å¯†é’¥å¯¹
ssh-keygen -t ed25519 -C "github-actions@example.com"

# å°†å…¬é’¥æ·»åŠ åˆ°æœåŠ¡å™¨
ssh-copy-id -i ~/.ssh/id_ed25519.pub username@server-ip

# å°†ç§é’¥å†…å®¹å¤åˆ¶åˆ° GitHub Secrets
cat ~/.ssh/id_ed25519
```

### 4. æœåŠ¡å™¨å‡†å¤‡

ç¡®ä¿æœåŠ¡å™¨å·²å®‰è£… Docker å’Œ Docker Composeï¼š

```bash
# å®‰è£… Docker
curl -fsSL https://get.docker.com | sh

# å®‰è£… Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# å¯åŠ¨ Docker æœåŠ¡
sudo systemctl start docker
sudo systemctl enable docker
```

#### é…ç½®Dockerä½¿ç”¨ä¸å®‰å…¨çš„Harbor Registry

ç”±äºHarborä½¿ç”¨è‡ªç­¾åè¯ä¹¦ï¼Œéœ€è¦é…ç½®Dockerå…è®¸ä¸å®‰å…¨çš„registryï¼š

```bash
# æ–¹æ³•1ï¼šä½¿ç”¨æä¾›çš„è„šæœ¬ï¼ˆæ¨èï¼‰
sudo ./scripts/setup-docker-registry.sh

# æ–¹æ³•2ï¼šæ‰‹åŠ¨é…ç½®
sudo mkdir -p /etc/docker
echo '{"insecure-registries": ["harbor.5845.cn"]}' | sudo tee /etc/docker/daemon.json
sudo systemctl restart docker
```

### 5. åˆ›å»ºéƒ¨ç½²ç›®å½•

åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºéƒ¨ç½²ç›®å½•ï¼š

```bash
mkdir -p /opt/myapi
cd /opt/myapi
```

## ğŸš€ å·¥ä½œæµç¨‹

### è‡ªåŠ¨éƒ¨ç½²æµç¨‹

1. **ä»£ç æ¨é€**: å‘ `main` åˆ†æ”¯æ¨é€ä»£ç 
2. **è§¦å‘æ„å»º**: GitHub Actions è‡ªåŠ¨è§¦å‘æ„å»ºæµç¨‹
3. **æ„å»ºé•œåƒ**: æ„å»º Docker é•œåƒå¹¶æ¨é€åˆ° Harbor ç§æœ‰ä»“åº“
4. **éƒ¨ç½²åˆ°æœåŠ¡å™¨**: é€šè¿‡ SSH è¿æ¥åˆ°æœåŠ¡å™¨å¹¶éƒ¨ç½²æ–°é•œåƒ
5. **å¥åº·æ£€æŸ¥**: éªŒè¯æœåŠ¡æ˜¯å¦æ­£å¸¸å¯åŠ¨

### æ‰‹åŠ¨éƒ¨ç½²

å¦‚æœéœ€è¦æ‰‹åŠ¨éƒ¨ç½²ï¼Œå¯ä»¥ä½¿ç”¨æä¾›çš„éƒ¨ç½²è„šæœ¬ï¼š

```bash
# åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œ
./scripts/deploy.sh [é•œåƒæ ‡ç­¾]
```

## ğŸ“ æ–‡ä»¶ç»“æ„

```
.github/
â””â”€â”€ workflows/
    â”œâ”€â”€ ci-cd.yml      # å®Œæ•´çš„CI/CDæµç¨‹ï¼ˆåŒ…å«æµ‹è¯•ï¼‰
    â””â”€â”€ deploy.yml     # ç®€åŒ–çš„è‡ªåŠ¨éƒ¨ç½²æµç¨‹

scripts/
â””â”€â”€ deploy.sh         # æœåŠ¡å™¨ç«¯éƒ¨ç½²è„šæœ¬

docs/
â””â”€â”€ github-actions-setup.md  # æœ¬æ–‡æ¡£
```

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **Harbor è®¤è¯å¤±è´¥**
   - æ£€æŸ¥ Harbor ç”¨æˆ·åå’Œå¯†ç æ˜¯å¦æ­£ç¡®
   - ç¡®è®¤ç”¨æˆ·æœ‰æ¨é€é•œåƒåˆ° `myapi` é¡¹ç›®çš„æƒé™
   - æ£€æŸ¥ Harbor æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ

2. **SSH è¿æ¥å¤±è´¥**
   - æ£€æŸ¥æœåŠ¡å™¨ IP å’Œç«¯å£æ˜¯å¦æ­£ç¡®
   - ç¡®è®¤ SSH å¯†é’¥å·²æ­£ç¡®é…ç½®
   - æ£€æŸ¥æœåŠ¡å™¨é˜²ç«å¢™è®¾ç½®

3. **Docker é•œåƒæ‹‰å–å¤±è´¥**
   - ç¡®è®¤æœåŠ¡å™¨å¯ä»¥è®¿é—® Harbor ä»“åº“
   - æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒDNSè§£æ
   - ç¡®è®¤æœåŠ¡å™¨å·²ç™»å½•åˆ° Harbor
   - æ£€æŸ¥Dockeræ˜¯å¦é…ç½®äº†insecure-registries
   - è¿è¡Œ `sudo ./scripts/setup-docker-registry.sh` é…ç½®Docker

4. **æœåŠ¡å¯åŠ¨å¤±è´¥**
   - æŸ¥çœ‹å®¹å™¨æ—¥å¿—ï¼š`docker-compose logs myapi`
   - æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
   - ç¡®è®¤ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®

### æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€

```bash
# æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker-compose logs -f myapi

# æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
curl -f http://localhost:5201/docs
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### GitHub Actions æ—¥å¿—

åœ¨ GitHub ä»“åº“çš„ `Actions` æ ‡ç­¾é¡µå¯ä»¥æŸ¥çœ‹ï¼š
- æ„å»ºçŠ¶æ€
- éƒ¨ç½²æ—¥å¿—
- é”™è¯¯ä¿¡æ¯

### Harbor é•œåƒç®¡ç†

åœ¨ [Harbor æ§åˆ¶å°](http://harbor.5845.cn/) å¯ä»¥ï¼š
- æŸ¥çœ‹é•œåƒç‰ˆæœ¬
- ç®¡ç†é•œåƒæ ‡ç­¾
- è®¾ç½®é•œåƒæ‰«æç­–ç•¥
- é…ç½®é•œåƒå¤åˆ¶è§„åˆ™

### æœåŠ¡å™¨ç›‘æ§

```bash
# æŸ¥çœ‹ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ
docker stats

# æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨
docker stats myapi

# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨æƒ…å†µ
df -h
```

## ğŸ”’ å®‰å…¨å»ºè®®

1. **Harbor å®‰å…¨**:
   - ä½¿ç”¨å¼ºå¯†ç 
   - å®šæœŸæ›´æ–° Harbor ç‰ˆæœ¬
   - é…ç½®é•œåƒæ‰«æ
   - è®¾ç½®è®¿é—®æ§åˆ¶ç­–ç•¥

2. **æœåŠ¡å™¨å®‰å…¨**:
   - ä½¿ç”¨ä¸“ç”¨ç”¨æˆ·è¿›è¡Œéƒ¨ç½²
   - é™åˆ¶ SSH è®¿é—®
   - å®šæœŸæ›´æ–°ç³»ç»Ÿ
   - ç›‘æ§ç³»ç»Ÿæ—¥å¿—

3. **é•œåƒå®‰å…¨**:
   - å®šæœŸæ›´æ–°åŸºç¡€é•œåƒ
   - æ‰«æé•œåƒæ¼æ´
   - ä½¿ç”¨æœ€å°åŒ–åŸºç¡€é•œåƒ
   - å®šæœŸæ¸…ç†æ—§é•œåƒ

## ğŸ“ æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š

1. æŸ¥çœ‹ GitHub Actions æ—¥å¿—
2. æ£€æŸ¥ Harbor é•œåƒä»“åº“çŠ¶æ€
3. æŸ¥çœ‹æœåŠ¡å™¨å®¹å™¨æ—¥å¿—
4. ç¡®è®¤æ‰€æœ‰é…ç½®æ˜¯å¦æ­£ç¡®
5. è”ç³»æŠ€æœ¯æ”¯æŒ 